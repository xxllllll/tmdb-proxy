services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  tmdb-proxy:
    image: ghcr.io/xxllllll/tmdb-proxy:latest
    container_name: tmdb-proxy
    restart: unless-stopped
    environment:
      PORT: 3000
      TMDB_API_BASE_URL: https://api.themoviedb.org
      TMDB_IMAGE_BASE_URL: https://image.tmdb.org
      CACHE_DURATION_MS: 600000
      MAX_CACHE_SIZE: 1000
      MAX_CACHE_BODY_BYTES: 1048576
    labels:
      - traefik.enable=true
      - traefik.http.services.tmdb-proxy.loadbalancer.server.port=3000

      - traefik.http.middlewares.tmdb-proxy-compress.compress=true

      # 图片路由：不启用 gzip（回滚无需操作）
      - "traefik.http.routers.tmdb-proxy-img.rule=PathPrefix(`/t/p/`)"
      - traefik.http.routers.tmdb-proxy-img.priority=100
      - traefik.http.routers.tmdb-proxy-img.entrypoints=web
      - traefik.http.routers.tmdb-proxy-img.service=tmdb-proxy

      # API 路由：启用 gzip（回滚：移除 middlewares 标签即可）
      - "traefik.http.routers.tmdb-proxy-api.rule=PathPrefix(`/`)"
      - traefik.http.routers.tmdb-proxy-api.priority=1
      - traefik.http.routers.tmdb-proxy-api.entrypoints=web
      - traefik.http.routers.tmdb-proxy-api.service=tmdb-proxy
      - traefik.http.routers.tmdb-proxy-api.middlewares=tmdb-proxy-compress@docker
