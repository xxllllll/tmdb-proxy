"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"TMDBP-000","P0","1","infra","基线与验收口径落盘","梳理部署拓扑与代表性请求集合，并把性能/成本基线指标与回滚开关清单写入文档，作为后续优化的统一验收依据。","Report.md 中新增/更新基线对比表：API 响应大小、p50/p95/p99 耗时、上游 403/5xx 比例、Traefik CPU、Node 内存/句柄数、cache hit/miss；附复现命令（curl + 压测工具）与每项优化对应的回滚开关清单。","AUTOSERVER","不引入新依赖或破坏现有接口；指标口径可复现且包含采样时间窗；回滚开关命名/默认值与实现保持一致；日志字段不泄露 api_key。","使用同一请求集合重复采样并与基线表一致；确认后续每项变更都能通过回滚开关单独关闭并恢复到基线行为。","已完成","已完成","已完成","已提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:17;Report.md:1;compose.yaml:1","picked_reason:P0 且作为后续优化的统一基线/回滚验收依据; started_at:2026-01-12T11:02:18; done_at:2026-01-12T11:06:59; evidence:Report.md 新增 4.3 基线表/复现命令/回滚开关清单; validation_limited:repo 无自动化测试脚本（npm test 直接退出）; manual_test:打开 Report.md 检查 4.3 小节；或 rg ""基线对比表"" Report.md; risk:low doc-only"
"TMDBP-010","P0","2","infra","Traefik 仅对 API 开启 gzip","在 Traefik 侧新增 compress middleware，并拆分 router 只让 API 走 gzip，确保 /t/p/ 图片路由不被压缩；同时把可复制的部署示例写入仓库。","仓库内提供可运行的 Traefik 配置（README.md 或 compose 示例）；curl -H 'Accept-Encoding: gzip' -I 验证 API 返回 Content-Encoding: gzip；对 /t/p/ 验证不包含 Content-Encoding: gzip；路由优先级明确且不会误匹配图片。","AUTOE2E","不改变应用层 header 透传/缓存语义；middleware 只挂 API router；配置文件可直接复制运行且包含回滚说明。","在启用/禁用 middleware 两种状态下分别烟测 API/图片；检查缓存与 CORS 行为无回归；观察 Traefik CPU/延迟无异常放大。","已完成","已完成","已完成","已提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:22;compose.yaml:1;README.md:1;.github/workflows/docker.yml:1","picked_reason:P0 且可立即降低带宽占用，且不改应用行为; started_at:2026-01-12T11:08:23; done_at:2026-01-12T11:11:07; evidence:新增 compose.traefik.yaml + README Traefik gzip 验收/回滚说明; validation_limited:当前环境缺少 docker/compose，无法真实启动 Traefik 进行 curl 验证; manual_test:docker compose -f compose.traefik.yaml up -d；按 README 中 curl 验证 API gzip 且图片不 gzip；回滚移除 middlewares 标签; risk:medium 需依赖 Traefik 路由优先级配置，错误会导致图片被 gzip（可回滚）"
"TMDBP-020","P1","3","backend","上游请求启用 keep-alive","为 API(axios) 与 图片(https.request) 引入共享 keep-alive Agent，并以 env 开关控制启用/关闭，以降低 TLS 建连与尾延迟。","src/tmdbProxy.js 使用共享 https.Agent({ keepAlive: true }) 作为 axios httpsAgent 与图片 upstream agent；新增环境变量开关且默认值明确；并发压测对比 upstream_duration_ms 的 p95/p99 不上升且有下降趋势；连接数/句柄数随时间稳定（无 socket 泄漏）。","AUTOSERVER","Agent 作用域清晰（单例/可注入）且不影响现有行为；开关可回滚；错误处理与超时策略明确；不透传 keep-alive 等 hop-by-hop header。","在开关开/关下分别跑并发与长时间运行场景；验证 API/图片功能与缓存一致；观察进程句柄/内存不持续增长。","已完成","已完成","已完成","已提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:28;src/tmdbProxy.js:236;src/tmdbProxy.js:303;src/tmdbProxy.js:188;README.md:86","picked_reason:P1 且为所有上游请求降低建连成本，后续优化共用; started_at:2026-01-12T11:11:40; done_at:2026-01-12T11:14:28; evidence:src/tmdbProxy.js 为 API(axios) 与图片(https.request) 增加共享 https.Agent keep-alive，并提供 UPSTREAM_KEEP_ALIVE 开关; validation_limited:未运行并发压测/真实上游请求（无 TMDB 凭证/无压测工具基线），仅做本地 require/初始化检查; manual_test:UPSTREAM_KEEP_ALIVE=false/true 分别启动服务；用 curl/hey/wrk 并发请求同一 API 路径，对比 upstream_duration_ms 分位；监控 docker stats 或 /proc/1/fd 句柄数随时间稳定; risk:medium 连接复用可能影响 socket/句柄占用，需在真实负载下观察"
"TMDBP-030","P1","4","backend","cache miss singleflight 合并并发","对 cacheable GET(API) 的同一 cacheKey 合并并发请求：命中 inflight 时复用同一 upstream 结果，减少 cache miss 风暴，保持 skip_status/skip_size 语义不变。","对同一路径并发 N 次请求，上游请求次数≈1（通过日志/计数验证）；inflight 在 finally 清理且无泄漏；错误/非200/超大响应处理与现有 skip_status/skip_size 行为一致；同批并发返回一致的 status/body。","AUTOSERVER","仅对 cacheable GET 启用且不影响图片；异常/超时兜底避免 inflight 堵塞；Map 不无限增长；日志能区分 singleflight hit/miss。","覆盖并发、超时、上游 4xx/5xx、超大响应等场景；验证 cache hit/miss/store 统计仍可信；长时间压测下内存稳定。","已完成","已完成","已完成","已提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:35;src/tmdbProxy.js:273;src/tmdbProxy.js:278;src/tmdbProxy.js:333;src/tmdbProxy.js:200;README.md:88","picked_reason:P1 减少 cache miss 并发风暴，降低上游配额压力; started_at:2026-01-12T11:16:54; done_at:2026-01-12T11:20:29; evidence:本地并发验证 singleflight 开关，off upstreamHits=30 / on upstreamHits=1（concurrency=30, ok=true）; evidence2:覆盖 200/store、500、200超大(skip_size) 三类场景均 upstreamHits=1（见执行输出 JSON）; risk:low~medium 仅影响 cacheable GET 的并发去重，失败时回退为原有并发上游请求"
"TMDBP-040","P2","5","backend","缓存阈值调参（数据驱动）","基于基线与压测数据，评估并调整 MAX_CACHE_BODY_BYTES 与 MAX_CACHE_SIZE 组合档位，提升热点大包接口命中率并控制内存峰值。","给出 1-2 套推荐 env 档位并在文档落盘；在代表性请求集合下 cache store/hit 提升、上游请求下降；压测窗口内容器内存/GC 无持续攀升；可一键回滚到默认值。","AUTOSERVER","所有阈值只通过 env 控制且默认保持现状；记录决策依据（数据与压测参数）；避免缓存异常/非预期响应。","在不同档位切换下重复压测与烟测；验证 cache 行为与 skip_size/skip_status 无回归；确认内存上限与 OOM 风险可控。","未开始","未开始","未开始","未提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:42;src/tmdbProxy.js:188;src/tmdbProxy.js:190;Report.md:1",""
"TMDBP-050","P2","6","backend","日志降噪/采样（保留错误全量）","为高 QPS 场景引入访问日志采样或按路径降噪（例如图片请求），但保证 4xx/5xx 与异常日志完整，避免 I/O 成为瓶颈。","新增可配置采样/降噪策略（默认不改变现状或有明确默认）；在高 QPS 图片场景日志量显著下降；4xx/5xx 与 error 事件仍 100% 记录且包含 request_id/关键字段。","AUTOSERVER","采样逻辑简单且可关闭；不改变 JSON 日志结构/关键字段；确保不记录敏感信息（api_key 已脱敏）。","在采样开/关下验证 request.end/request.aborted 与错误日志完整；压测下 CPU/IO 不成为瓶颈；排障所需字段可用。","已完成","已完成","已完成","已提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:47;src/tmdbProxy.js:55;src/tmdbProxy.js:370;src/tmdbProxy.js:215;src/tmdbProxy.js:479;README.md:91","picked_reason:P2 减少高QPS图片场景日志I/O，降低CPU与磁盘压力; started_at:2026-01-12T11:22:06; done_at:2026-01-12T11:24:11; evidence:本地验证 ACCESS_LOG_SAMPLE_RATE=0 时 2xx request.end 不输出，5xx 仍全量（request_end_logs_total=1, ok=true）; risk:low 默认 sample_rate=1 不改变现状；仅对 <400 的 request.end 进行采样"
"TMDBP-060","P1","7","infra","回归验证与分步发布","补齐文档与部署示例，并按 P0→P1→P2 顺序发布，每步观察指标再推进，确保可一键回滚。","README.md/部署示例包含环境变量说明与 Traefik 路由/gzip 配置；完成烟测清单：API/图片、CORS、Authorization/Accept-Language 维度缓存、gzip 行为；发布记录包含每步观察指标与回滚操作。","AUTOE2E","文档与示例保持可复制；明确多副本缓存不共享预期；发布步骤不跳跃且每步可独立回滚。","在 staging/生产等价环境跑全链路回归；对比基线指标无明显退化；验证开关回滚后行为与基线一致。","未开始","未开始","未开始","未提交","","plan/2026-01-12_10-47-56-tmdb-proxy-perf-traefik.md:51;README.md:1;compose.yaml:1;Report.md:1;.github/workflows/docker.yml:1",""
